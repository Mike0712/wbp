<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WB Viewer</title>
  <style>
    html,body{height:100%;margin:0}
    #wrap{display:flex;flex-direction:column;height:100%}
    #video{flex:1;background:#111;display:flex;align-items:center;justify-content:center}
    video{max-width:100%;max-height:100%;background:#000}
    #bar{padding:8px;display:flex;gap:8px;align-items:center;background:#f5f5f5}
  </style>
  <!-- ВАЖНО: UMD-бандл, а не lib/index.js -->
  <script src="https://cdn.jsdelivr.net/npm/mediasoup-client@3/dist/mediasoup-client.min.js"></script>
</head>
<body>
  <div id="wrap">
    <div id="bar"><strong>Seller:</strong>&nbsp;<code id="sc"></code></div>
    <div id="video"><em style="color:#bbb">Connecting...</em></div>
  </div>

  <script>
    (async function () {
      const mediasoupClient = window.mediasoupClient; // UMD-глобал
      const qs = new URLSearchParams(location.search);
      const sellerCode = qs.get('seller') || 'sellerA';
      const sid = qs.get('sid');
      document.getElementById('sc').textContent = sellerCode;

      const proto = (location.protocol === 'https:') ? 'wss' : 'ws';
      const ws = new WebSocket(`wss://${location.host}`);
      function send(type, data){ ws.send(JSON.stringify({ type, data })); }

      let device, transport;
      const videoWrap = document.getElementById('video');
      const videoEl = document.createElement('video');
      videoEl.autoplay = true; videoEl.playsInline = true;

      ws.onopen = () => send('join', { sellerCode, sid });
      ws.onmessage = async (ev) => {
        const { type, data } = JSON.parse(ev.data);
        if (type === 'webrtctransport') {
          device = new mediasoupClient.Device();
          await device.load({ routerRtpCapabilities: data.rtpCapabilities });
          transport = device.createRecvTransport({
            id: data.id,
            iceParameters: data.iceParameters,
            iceCandidates: data.iceCandidates,
            dtlsParameters: data.dtlsParameters
          });
          transport.on('connect', ({ dtlsParameters }, cb) => { send('connect', { dtlsParameters }); cb(); });
        } else if (type === 'consumers') {
          for (const c of data) {
            const consumer = await transport.consume({ id: c.id, producerId: c.producerId, kind: c.kind, rtpParameters: c.rtpParameters });
            if (c.kind === 'video') {
              videoEl.srcObject = new MediaStream([consumer.track]);
              if (!videoEl.isConnected) videoWrap.innerHTML = '', videoWrap.appendChild(videoEl);
            } else {
              const a = document.createElement('audio');
              a.autoplay = true; a.srcObject = new MediaStream([consumer.track]);
              videoWrap.appendChild(a);
            }
          }
        } else if (type === 'error') {
          alert(data);
        }
      };

      // (опционально) простые управлялки
      videoWrap.addEventListener('mousemove', (e)=>{
        const r = videoEl.getBoundingClientRect();
        if (!r.width || !r.height) return;
        const x = Math.round((e.clientX - r.left) / r.width * 1600);
        const y = Math.round((e.clientY - r.top)  / r.height * 900);
        send('control', { type:'mousemove', x, y });
      });
      videoWrap.addEventListener('click', ()=> send('control', { type:'click' }));
      window.addEventListener('keydown', (e)=> send('control', { type:'key', key: e.key }));
    })();
  </script>
</body>
</html>
