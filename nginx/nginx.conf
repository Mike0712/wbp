worker_processes auto;
events { worker_connections 2048; }
http {
  include mime.types;
  sendfile on;
  proxy_buffering off;
  proxy_read_timeout 3600s;
  proxy_send_timeout 3600s;

  # >>> Replace these with your real seller servers' IPs or hostnames
  upstream sellerI_up { server 188.225.11.208:8080; }  # Ilyasov noVNC
  upstream sellerN_up { server 5.129.192.117:8080; }  # Nabiev noVNC
  upstream sellerB_up { server 176.98.176.87:8080; }  # Berest C noVNC
  upstream sellerC_up { server 77.232.128.171:8080; }  # Churikov D noVNC

  map $pool $upstream_pool {
    default "";
    sellerI sellerI_up;
    sellerN sellerN_up;
    sellerB sellerB_up;
    sellerC sellerC_up;
  }

  server {
    listen 443 ssl http2;
    server_name proxy.wb.com;  # <<< replace with your domain

    ssl_certificate     /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;

    # Backend API + WebApp
    location /api/ { proxy_pass http://backend:3000; }
    location /     { proxy_pass http://backend:3000; }

    # Protected session to seller noVNC
    location ~ ^/s/(?<pool>sellerI|sellerB|sellerC|sellerN)/(?<sid>[0-9a-fA-F-]{36})/ {
      auth_request /_auth;
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_pass http://$upstream_pool/;
    }

    location = /_auth {
      internal;
      proxy_pass http://backend:3000/api/authorize?pool=$pool&sid=$sid;
      proxy_pass_request_body off;
      proxy_set_header Content-Length "";
    }
  }

  server { listen 80; return 301 https://$host$request_uri; }
}
